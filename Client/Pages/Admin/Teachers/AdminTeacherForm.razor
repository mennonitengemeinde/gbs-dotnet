@page "/admin/teachers/create"
@page "/admin/teachers/{Id:int}/edit"
@attribute [Authorize(Roles = Roles.AdminAndSound)]
@inject NavigationManager NavigationManager
@inject ITeacherService TeacherService
@inject IUiService UiService

<EditForm Model="_newTeacher" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator/>
    <MudGrid Justify="Justify.Center" Class="tw-pt-8">
        <MudItem xs="12" sm="8" md="5">
            <MatFormCard Label="Teacher"
                         IsEdit="@_isEdit"
                         IsLoading="@_isLoading"
                         IsProcessing="@_isProcessing"
                         ReturnUrl="/admin/teachers">
                <MudTextField Label="Name"
                              @bind-Value="_newTeacher.Name"
                              For="() => _newTeacher.Name"/>
            </MatFormCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {
    TeacherCreateDto _newTeacher = new TeacherCreateDto();
    bool _isProcessing;
    bool _isLoading;
    bool _isEdit;

    [Parameter]
    public int? Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (Id != null)
        {
            _isEdit = true;
            _isLoading = true;
            var teacher = await TeacherService.FetchTeacher(Id.Value);
            _newTeacher = new TeacherCreateDto
            {
                Name = teacher.Data.Name
            };
            _isLoading = false;
        }
    }

    async Task HandleValidSubmit()
    {
        _isProcessing = true;
        var response = _isEdit == false 
            ? await TeacherService.AddTeacher(_newTeacher) 
            : await TeacherService.UpdateTeacher(Id!.Value, _newTeacher);

        if (response.Success)
        {
            _isProcessing = false;
            UiService.ShowSuccessAlert(_isEdit ? "Teacher updated successfully" : "Teacher added successfully");
            NavigationManager.NavigateTo("admin/teachers");
        }
        else
        {
            _isProcessing = false;
            await UiService.ShowErrorAlert(response.Message, response.StatusCode);
        }
    }

}
@inject IUiService UiService
@inject NavigationManager NavigationManager

<EditForm Model="_model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <MudGrid Justify="Justify.Center" Class="tw-pt-8">
        <MudItem xs="12" sm="8" md="5">
            <MatFormCard Label="Church"
                         IsEdit="true"
                         IsLoading="@ChurchState.IsLoading"
                         IsProcessing="@_isProcessing"
                         ReturnUrl="/admin/churches"
                         ValidationErrors="@ValidationErrors">
                <MudTextField Label="Name"
                              @bind-Value="_model.Name"
                              Required="true"
                              For="() => _model.Name" />
                <MudTextField Label="Address"
                              @bind-Value="_model.Address"
                              For="() => _model.Address" />
                <MudTextField Label="City"
                              @bind-Value="_model.City"
                              For="() => _model.City" />
                <MudTextField Label="State"
                              @bind-Value="_model.State"
                              For="() => _model.State" />
                <MudTextField Label="Country"
                              @bind-Value="_model.Country"
                              Required="true"
                              For="() => _model.Country" />
                <MudTextField Label="PostalCode"
                              @bind-Value="_model.PostalCode"
                              For="() => _model.PostalCode" />
            </MatFormCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {

    [Parameter, EditorRequired]
    public int Id { get; set; }

    [CascadingParameter]
    public ChurchState ChurchState { get; set; } = null!;

    UpdateChurchRequest _model = new();
    bool _isProcessing;
    string[]? ValidationErrors { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var church = await ChurchState.GetById(Id);
        if (church == null)
        {
            await UiService.ShowErrorAlert("Church not found");
            NavigationManager.NavigateTo("/admin/churches");
            return;
        }

        _model.Name = church.Name;
        _model.Address = church.Address;
        _model.City = church.City;
        _model.State = church.State;
        _model.PostalCode = church.PostalCode;
        _model.Country = church.Country;
    }

    async Task HandleValidSubmit()
    {
        _isProcessing = true;

        await ChurchState.Update(Id, _model);

        if (ChurchState.HasError)
        {
            _isProcessing = false;
            ValidationErrors = ChurchState.Errors;
            await UiService.ShowErrorAlert(ChurchState.ErrorMessage);
            ChurchState.ClearErrors();
        }
        else
        {
            _isProcessing = false;
            UiService.ShowSuccessAlert("Church updated successfully");
            NavigationManager.NavigateTo("admin/churches");
        }
    }

}
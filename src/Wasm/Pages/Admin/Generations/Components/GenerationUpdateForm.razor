@inject NavigationManager NavigationManager
@inject IUiService UiService

<EditForm Model="_model" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <MudGrid Justify="Justify.Center" Class="tw-pt-8">
        <MudItem xs="12" sm="8" md="5">
            <MatFormCard Label="Generation"
                         IsEdit="true"
                         IsLoading="@GenerationState.IsLoading"
                         IsProcessing="@_isProcessing"
                         ValidationErrors="@_errors"
                         ReturnUrl="/admin/generations">
                <MudTextField Label="Name"
                              @bind-Value="_model.Name"
                              For="() => _model.Name" />
            </MatFormCard>
        </MudItem>
    </MudGrid>
</EditForm>

@code {

    [CascadingParameter]
    public GenerationState GenerationState { get; set; } = null!;

    UpdateGenerationRequest _model = new();
    bool _isProcessing;
    string[]? _errors;

    [Parameter, EditorRequired]
    public int Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        var generation = await GenerationState.GetById(Id);
        if (generation != null)
        {
            _model = new UpdateGenerationRequest
            {
                Id = generation.Id,
                Name = generation.Name
            };
        }
    }

    async Task HandleValidSubmit()
    {
        _isProcessing = true;
        await GenerationState.Update(Id, _model);

        if (GenerationState.HasError)
        {
            _errors = GenerationState.Errors;
            UiService.ShowErrorAlert(GenerationState.ErrorMessage);
            GenerationState.ClearErrors();
            _isProcessing = false;
        }
        else
        {
            _isProcessing = false;
            UiService.ShowSuccessAlert("Generation added successfully");
            NavigationManager.NavigateTo("admin/generations");
        }
    }

}